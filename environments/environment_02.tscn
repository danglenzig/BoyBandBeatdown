[gd_scene load_steps=24 format=3 uid="uid://b05i67tp5inti"]

[ext_resource type="Texture2D" uid="uid://bt2onc7k5tskk" path="res://environments/assets/env_03.png" id="1_06u37"]
[ext_resource type="Script" path="res://environments/environment.gd" id="1_lxl3m"]
[ext_resource type="Script" path="res://environments/game_camera.gd" id="2_ucf6c"]
[ext_resource type="PackedScene" uid="uid://ndpd1xkg8gor" path="res://encounters/npc_encounter.tscn" id="2_v0oil"]
[ext_resource type="Script" path="res://environments/z_scaler.gd" id="5_kgyjn"]
[ext_resource type="PackedScene" uid="uid://draw6d8dxgu4k" path="res://npcs/marcie/marcie_sprite.tscn" id="6_rig6d"]
[ext_resource type="Script" path="res://environments/exit_trigger.gd" id="7_cobnl"]
[ext_resource type="Script" path="res://environments/npc_spawner.gd" id="8_ejrya"]
[ext_resource type="PackedScene" uid="uid://bihf2ljwlb42y" path="res://npcs/gretchen/gretchen_sprite.tscn" id="9_fkg1w"]
[ext_resource type="Texture2D" uid="uid://dp3xm2qtpej40" path="res://environments/assets/etc/MM_1.png" id="10_e3anp"]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_48wd4"]
size = Vector2(789.068, 138.372)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_xoebj"]
size = Vector2(104, 345)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_ecici"]
size = Vector2(167.5, 18)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_sxdnm"]
size = Vector2(173, 61)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_sonuw"]
size = Vector2(274, 28)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_y4l3q"]
size = Vector2(107, 100)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_1clnj"]
size = Vector2(634.206, 74.8383)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_0q1ox"]
size = Vector2(101, 283)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_4yfy4"]
size = Vector2(1681, 122)

[sub_resource type="CircleShape2D" id="CircleShape2D_a0opc"]
radius = 162.308

[sub_resource type="NavigationPolygon" id="NavigationPolygon_br120"]
vertices = PackedVector2Array(1601.01, 1248.93, 40.2813, 1244.1, 940.844, 673.039, 1134.43, 718.039, 1137.3, 675.844, 1217.27, 735.031)
polygons = Array[PackedInt32Array]([PackedInt32Array(0, 1, 2, 3), PackedInt32Array(2, 4, 3), PackedInt32Array(0, 3, 5)])
outlines = Array[PackedVector2Array]([PackedVector2Array(938, 663, 1148, 666, 1145, 710, 1223, 726, 1621, 1259, 6, 1254)])

[sub_resource type="Shader" id="Shader_ru0p4"]
code = "//ATTENTION:
//  THIS IS SHADE AUTOGENERATED BY
//  THE ADDON SPRITE-SHADER-MIXER
//  ANY MANUAL CHANGES WILL BE REMOVED WHEN THE ADDON
//  UPDATES THIS SHADER.
//  ANYWAY, YOU CAN SAVE THE CURRENT VERSION AS A RESOURCE FILE.
//SHADERS:Pseudo3D,
shader_type canvas_item;

uniform float opacity:hint_range(0.0, 1.0, 0.01)=1.;

	

// Camera FOV.,- - <MM
uniform bool PSEUDO3D_active = true;
uniform float PSEUDO3D_fov : hint_range(1, 179) = 90;
uniform float PSEUDO3D_y_rot : hint_range(-180, 180) = 50.0;
uniform float PSEUDO3D_x_rot : hint_range(-180, 180) = 0.0;
// At 0, the image retains its size when unrotated.
// At 1, the image is resized so that it can do a full
// rotation without clipping inside its rect.
uniform float PSEUDO3D_inset : hint_range(0, 1) = 0.0;
// Consider changing this to a uniform and changing it from code
varying flat vec2 PSEUDO3D_o;
varying vec3 PSEUDO3D_p;
// Creates rotation matrix
void pseudo3d_vertex(in vec2 uv, inout vec3 p, inout vec2 o, inout vec2 vertex, vec2 pixelSize){
	float sin_b = sin(PSEUDO3D_y_rot / 180.0 * PI);
	float cos_b = cos(PSEUDO3D_y_rot / 180.0 * PI);
	float sin_c = sin(PSEUDO3D_x_rot / 180.0 * PI);
	float cos_c = cos(PSEUDO3D_x_rot / 180.0 * PI);
	
	mat3 inv_rot_mat;
	inv_rot_mat[0][0] = cos_b;
	inv_rot_mat[0][1] = 0.0;
	inv_rot_mat[0][2] = -sin_b;
	
	inv_rot_mat[1][0] = sin_b * sin_c;
	inv_rot_mat[1][1] = cos_c;
	inv_rot_mat[1][2] = cos_b * sin_c;
	
	inv_rot_mat[2][0] = sin_b * cos_c;
	inv_rot_mat[2][1] = -sin_c;
	inv_rot_mat[2][2] = cos_b * cos_c;
	
	
	float t = tan(PSEUDO3D_fov / 360.0 * PI);
	p = inv_rot_mat * vec3((uv - 0.5), 0.5 / t);
	float v = (0.5 / t) + 0.5;
	p.xy *= v * inv_rot_mat[2].z;
	o = v * inv_rot_mat[2].xy;

	vertex += (uv - 0.5) / pixelSize * t * (1.0 - PSEUDO3D_inset);
}
void pseudo3d(inout vec2 uv, in sampler2D txt, vec2 size, vec2 pixelSize, inout vec4 color) {
		vec2 newUV = (PSEUDO3D_p.xy / PSEUDO3D_p.z).xy - PSEUDO3D_o;
        uv=newUV;
	    color = texture(txt, newUV + 0.5);
		color.a *= step(max(abs(newUV.x), abs(newUV.y)), 0.5);
}


void fragment() {
	vec4 color = texture(TEXTURE, UV);
	vec2 size = vec2(textureSize(TEXTURE, 0));
	vec2 uv = UV;
	vec2 screen_uv = SCREEN_UV;

	if(PSEUDO3D_active) pseudo3d(uv, TEXTURE, size, TEXTURE_PIXEL_SIZE, color);


	color.a*=opacity;
	COLOR=color;
}

void vertex() {
	
	PSEUDO3D_p=vec3(1,1,1);
	PSEUDO3D_o=vec2(1,1);
	pseudo3d_vertex(UV,PSEUDO3D_p,PSEUDO3D_o,VERTEX,TEXTURE_PIXEL_SIZE);

}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_242aa"]
shader = SubResource("Shader_ru0p4")
shader_parameter/opacity = 1.0
shader_parameter/PSEUDO3D_active = true
shader_parameter/PSEUDO3D_fov = 90.0
shader_parameter/PSEUDO3D_y_rot = 0.740009
shader_parameter/PSEUDO3D_x_rot = 0.0
shader_parameter/PSEUDO3D_inset = 0.0

[node name="Environment_02" type="Node2D"]
script = ExtResource("1_lxl3m")
camera_upper_y = 440
camera_lower_y = 640
camera_left_x = 790
camera_right_x = 820
encounter_scene = ExtResource("2_v0oil")
environment_background_filename = "env_03.png"
encounter_background_filename = "00.png"
is_indoor = true

[node name="TextureRect" type="TextureRect" parent="."]
offset_right = 40.0
offset_bottom = 40.0
texture = ExtResource("1_06u37")

[node name="GameCamera" type="Camera2D" parent="."]
position = Vector2(804, 634)
zoom = Vector2(0.865, 0.865)
script = ExtResource("2_ucf6c")

[node name="ZScaler" type="Node2D" parent="." node_paths=PackedStringArray("top_marker", "bottom_marker")]
script = ExtResource("5_kgyjn")
top_marker = NodePath("../TopMarker")
bottom_marker = NodePath("../BottomMarker")
scale_at_top = 0.45
scale_at_bottom = 2.0

[node name="TopMarker" type="Marker2D" parent="."]
position = Vector2(1044, 648)

[node name="BottomMarker" type="Marker2D" parent="."]
position = Vector2(777, 1073)

[node name="DefaultPlayerStart" type="Marker2D" parent="."]
position = Vector2(968, 797)

[node name="SouthPlayerStart" type="Marker2D" parent="."]
position = Vector2(626, 1207)

[node name="WestPlayerStart" type="Marker2D" parent="."]
position = Vector2(859, 831)

[node name="EnvironmentBlockers" type="StaticBody2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(279.225, 937.208)
rotation = -0.50091
shape = SubResource("RectangleShape2D_48wd4")

[node name="CollisionShape2D2" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(-38, 1229.5)
shape = SubResource("RectangleShape2D_xoebj")

[node name="CollisionShape2D3" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(731.25, 719)
shape = SubResource("RectangleShape2D_ecici")

[node name="CollisionShape2D4" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(875, 660)
rotation = -0.50091
shape = SubResource("RectangleShape2D_sxdnm")

[node name="CollisionShape2D5" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(1086, 638)
shape = SubResource("RectangleShape2D_sonuw")

[node name="CollisionShape2D6" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(1209.5, 677)
shape = SubResource("RectangleShape2D_y4l3q")

[node name="CollisionShape2D7" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(1482.03, 926.012)
rotation = 0.84823
shape = SubResource("RectangleShape2D_1clnj")

[node name="CollisionShape2D8" type="CollisionShape2D" parent="EnvironmentBlockers"]
position = Vector2(1666, 1257.5)
shape = SubResource("RectangleShape2D_0q1ox")

[node name="AllyHolder" type="Node2D" parent="."]

[node name="NpcHolder" type="Node2D" parent="."]

[node name="PropHolder" type="Node2D" parent="."]

[node name="ExitTriggerHolder" type="Node2D" parent="."]

[node name="ExitTrigger" type="Area2D" parent="ExitTriggerHolder"]
script = ExtResource("7_cobnl")
exit_to_scene_name = "environment_01.tscn"
player_start_name = "WestExitPlaceholderMarker"

[node name="CollisionShape2D" type="CollisionShape2D" parent="ExitTriggerHolder/ExitTrigger"]
position = Vector2(821, 1339)
shape = SubResource("RectangleShape2D_4yfy4")
debug_color = Color(0.952136, 6.73831e-07, 0.560163, 0.42)

[node name="ExitTrigger2" type="Area2D" parent="ExitTriggerHolder"]
script = ExtResource("7_cobnl")
exit_to_scene_name = "environment_05.tscn"
player_start_name = "NorthPlayerStart"

[node name="CollisionShape2D" type="CollisionShape2D" parent="ExitTriggerHolder/ExitTrigger2"]
position = Vector2(613, 677)
shape = SubResource("CircleShape2D_a0opc")
debug_color = Color(0.952136, 6.73831e-07, 0.560163, 0.42)

[node name="NpcSpawner" type="Node" parent="."]
script = ExtResource("8_ejrya")
npc_scenes = Array[PackedScene]([ExtResource("9_fkg1w"), ExtResource("6_rig6d")])

[node name="SpawnMarkers" type="Node2D" parent="NpcSpawner"]

[node name="Marker2D" type="Marker2D" parent="NpcSpawner/SpawnMarkers"]
position = Vector2(421, 1002)

[node name="Marker2D2" type="Marker2D" parent="NpcSpawner/SpawnMarkers"]
position = Vector2(1293, 828)

[node name="Marker2D3" type="Marker2D" parent="NpcSpawner/SpawnMarkers"]
position = Vector2(995, 702)

[node name="Marker2D4" type="Marker2D" parent="NpcSpawner/SpawnMarkers"]
position = Vector2(1071, 786)

[node name="NavigationRegion2D" type="NavigationRegion2D" parent="."]
navigation_polygon = SubResource("NavigationPolygon_br120")

[node name="CenterMarker" type="Marker2D" parent="NavigationRegion2D"]
position = Vector2(956, 828)

[node name="Etc" type="Node2D" parent="."]
visible = false

[node name="MM_WallPortrait" type="Sprite2D" parent="Etc"]
material = SubResource("ShaderMaterial_242aa")
position = Vector2(610, 425)
scale = Vector2(0.075, 0.075)
texture = ExtResource("10_e3anp")

[connection signal="body_entered" from="ExitTriggerHolder/ExitTrigger" to="ExitTriggerHolder/ExitTrigger" method="_on_body_entered"]
[connection signal="body_entered" from="ExitTriggerHolder/ExitTrigger2" to="ExitTriggerHolder/ExitTrigger2" method="_on_body_entered"]
